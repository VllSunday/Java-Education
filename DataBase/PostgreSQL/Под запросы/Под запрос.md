---
создал заметку: 2024-08-11
---


##  Под запросы(subqueries)
  Это такие запросы которые используются внутри другого запроса, или команды в SQL 

![[Pasted image 20240811073634.png]]

Под запросы заключаются в скобки. 
В данном примере мы видим запрос: извлечь максимальную стоимость из таблицы `products`

Этот подзапрос входит в состав внешнего запроса, который извлекает: ==id, name , price ==
из products 
И также есть условие: WHERE price  = (subqueries)
Которое примет какую то цену, из под запроса, и на основании этого значения будут отобраны продукты.


### Данные: 
![[Pasted image 20240811074251.png]]
Далее мы будем использовать вот эти данные для того что бы разбить подзапросы.


### Правила
 - Подзапросы выполняются первыми
 - Под запросы можно выполнить не зависимо от основного запроса

Например: 

``` SQL 
SELECT MAX(price)
FROM products
```
Данный запрос вернет нам значение в 60_000 

Затем мы можем подставить возвращаемое значение в место под запроса в исходный запрос:

```sql
SELECT id, name, price
FROM products
WHERE price = 60000
```

Таким образом мы получим то что, нам нужно извлечь: ==id, name , price ==
из products

Вот та строка что вернется из под запроса: 
![[Pasted image 20240811075210.png]]

### Еще пример: 
![[Pasted image 20240811075601.png]]
#### Например у нас есть такая БД. Нам нужно узнать какие продукты были проданы хотя-бы раз

  -Что мы можем сделать? 
Мы можешь сделать под запрос, с таблице ==sales== где храниться информация о проданных продуктах.
И уже получив какие то данные обработать их в основном запросе.

Вот как это можно выразить в виде запроса с под запросом: 

```SQL 
SELECT id, name, price
FROM products
WHERE id IN (SELECT product_id
			   FROM sales)
```
В под запросе мы извлекаем id-каторы продуктов (product_id) из таблицы sales
Таким образом получаем ==список== продуктов, которые были проданы 

#### Важно заметить что в данном запросе мы используем оператор IN потому что мы получаем ==список== id 

Вот как это будет выглядеть: 
![[Pasted image 20240811080534.png]]

## Важно понимать что ==под запросы== можно использовать не только с  `SELECT` но и в командах `UPDATE` & `INSERT` & `DELETE`

###### Вот пример под запроса в оператором UPDATE

Например нам нужно увеличить цену книги на 500 рублей

Вот как будет выглядеть запрос: 
```sql
UPDATE products
SET price = price + 500
WHERE type_id = (SELECT id
				 FROM product_types
				 WHERE type_name = 'Книга')
```
Для этого в под запросе мы находим идентификатор продукта, у которого название `Книга` 
А затем в команде `UPDATE` обновляем таблицу продуктов, и изменяем цену на 500 
При условии что идентификатор типа продукта (type_id) = равен типу продукта с названием книги, который вернул нам подзапрос.

![[Pasted image 20240811081553.png]]

