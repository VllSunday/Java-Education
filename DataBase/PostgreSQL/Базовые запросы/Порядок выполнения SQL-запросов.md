---
создал заметку: 2024-08-09
---
---

# Порядок выполнения SQL-запросов

## Введение
Порядок выполнения SQL-запросов (или порядок обработки) описывает, в каком порядке SQL-сервер обрабатывает различные части запроса. Это важно для понимания того, как писать и оптимизировать SQL-запросы.

## Этапы выполнения SQL-запроса

1. **`FROM` — Выборка таблиц**
   - SQL определяет, из каких таблиц будет происходить выборка данных. Если в запросе участвуют несколько таблиц, сначала выполняются соединения (`JOIN`), формируя базовый набор данных.

   ```sql
   SELECT * 
   FROM employees;
   ```

2. **`WHERE` — Фильтрация строк**
   - После выбора таблиц выполняется фильтрация строк. SQL обрабатывает условие в `WHERE`, чтобы отобрать только те строки, которые соответствуют заданным условиям. На этом этапе удаляются строки, которые не соответствуют критериям фильтрации.

   ```sql
   SELECT * 
   FROM employees
   WHERE department = 'Sales';
   ```

3. **`GROUP BY` — Группировка данных**
   - Если запрос включает `GROUP BY`, SQL группирует строки, которые имеют одинаковые значения в указанных столбцах. Этот этап происходит после фильтрации строк.

   ```sql
   SELECT department, SUM(salary) 
   FROM employees
   GROUP BY department;
   ```

4. **Агрегация — Вычисление агрегатных функций**
   - После группировки данных выполняются агрегатные функции, такие как `SUM`, `AVG`, `COUNT`, `MIN`, `MAX`. Эти функции применяются к каждой группе строк, созданной на этапе `GROUP BY`.

   ```sql
   SELECT department, SUM(salary) 
   FROM employees
   GROUP BY department;
   ```

5. **`HAVING` — Фильтрация групп**
   - На этом этапе происходит фильтрация уже сгруппированных данных. Условие `HAVING` применяется к группам, оставляя только те, которые соответствуют заданным условиям. Это похоже на `WHERE`, но работает именно с группами данных.

   ```sql
   SELECT department, SUM(salary) 
   FROM employees
   GROUP BY department
   HAVING SUM(salary) > 100000;
   ```

6. **`SELECT` — Выборка данных**
   - SQL выбирает и возвращает данные, которые будут показаны в результате запроса. На этом этапе вычисляются выражения и применяется форматирование, если оно указано. Также создаются и применяются алиасы (псевдонимы).

   ```sql
   SELECT department, SUM(salary) AS total_salary 
   FROM employees
   GROUP BY department
   HAVING SUM(salary) > 100000;
   ```

7. **`ORDER BY` — Сортировка данных**
   - На этом этапе SQL сортирует результаты запроса в соответствии с указанными столбцами или выражениями. Сортировка выполняется после того, как данные были выбраны и обработаны.

   ```sql
   SELECT department, SUM(salary) AS total_salary 
   FROM employees
   GROUP BY department
   HAVING SUM(salary) > 100000
   ORDER BY total_salary DESC;
   ```

8. **`LIMIT` — Ограничение количества возвращаемых строк**
   - В некоторых СУБД, таких как PostgreSQL и MySQL, существует возможность ограничения количества возвращаемых строк с помощью оператора `LIMIT`. Это последний шаг перед возвратом результатов пользователю.

   ```sql
   SELECT department, SUM(salary) AS total_salary 
   FROM employees
   GROUP BY department
   HAVING SUM(salary) > 100000
   ORDER BY total_salary DESC
   LIMIT 5;
   ```

## Почему важно понимать порядок выполнения

Понимание порядка выполнения SQL-запросов помогает:
- Правильно использовать условия `WHERE` и `HAVING`, не путать их применение.
- Эффективно использовать агрегатные функции и группировку.
- Оптимизировать запросы для повышения их производительности.
- Избегать ошибок при использовании алиасов в условиях `HAVING` и `ORDER BY`.

## Основные различия между `WHERE` и `HAVING`

- **`WHERE`** используется для фильтрации строк до выполнения группировки (`GROUP BY`) и агрегации.
- **`HAVING`** используется для фильтрации результатов после группировки и применения агрегатных функций.

### Пример разницы между `WHERE` и `HAVING`

```sql
-- Этот запрос отфильтрует данные до группировки:
SELECT department, COUNT(*)
FROM employees
WHERE salary > 50000
GROUP BY department;

-- Этот запрос отфильтрует данные после группировки:
SELECT department, SUM(salary) AS total_salary
FROM employees
GROUP BY department
HAVING total_salary > 200000;
```

Таким образом, `WHERE` используется для предварительной фильтрации данных, а `HAVING` — для фильтрации уже сгруппированных и агрегированных данных.

---
