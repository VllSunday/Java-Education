---
создал заметку: 2024-08-09
---
Операции над множествами в SQL включают такие операторы, как `UNION`, `INTERSECT`, и `EXCEPT`. Эти операторы позволяют выполнять операции с результатами двух или более запросов, так же как операции над множествами в теории множеств (математика). Но это не все операции, доступные в SQL.

---

# Операции над множествами в SQL

## Введение
Операции над множествами в SQL позволяют комбинировать результаты двух или более SELECT-запросов. Они работают по принципам теории множеств, объединяя, пересекая или вычитая наборы данных, полученные из различных запросов.

## Операторы множеств

### 1. **`UNION`**
   - **Описание**: ==Объединяет== результаты двух или более запросов, возвращая все уникальные строки из объединенных наборов данных.
   - **Применение**: Используется, когда необходимо объединить результаты из разных запросов и исключить дублирующиеся строки.
   - **Синтаксис**:
     ```sql
     SELECT column_list FROM table1
     UNION
     SELECT column_list FROM table2;
     ```
   - **Пример**:
     ```sql
     SELECT name FROM employees
     UNION
     SELECT name FROM contractors;
     ```
   - **Вариант**: `UNION ALL`
     - **Описание**: ==Возвращает все строки, включая дубликаты==.
     - **Применение**: Используется, когда необходимо сохранить все строки, даже если они дублируются.
     - **Синтаксис**:
       ```sql
       SELECT column_list FROM table1
       UNION ALL
       SELECT column_list FROM table2;
       ```

### 2. **`INTERSECT`**
   - **Описание**: ==Возвращает только те строки, которые присутствуют в обоих наборах данных==.
   - **Применение**: Используется, когда необходимо найти общие элементы между двумя наборами данных.
   - **Синтаксис**:
     ```sql
     SELECT column_list FROM table1
     INTERSECT
     SELECT column_list FROM table2;
     ```
   - **Пример**:
     ```sql
     SELECT name FROM employees
     INTERSECT
     SELECT name FROM contractors;
     ```

### 3. **`EXCEPT`**
   - **Описание**: ==Возвращает строки из первого набора данных, которые не присутствуют во втором наборе==
   - **Применение**: Используется, когда необходимо исключить строки, присутствующие в обоих наборах данных, и оставить только уникальные для первого набора.
   - ==Также накладывает на первое множество DISTINCT, то есть все значения будут уникальными==
   - **Синтаксис**:
     ```sql
     SELECT column_list FROM table1
     EXCEPT
     SELECT column_list FROM table2;
     ```
   - **Пример**:
     ```sql
     SELECT name FROM employees
     EXCEPT
     SELECT name FROM contractors;
     ```

### 4. **`MINUS`**
   - **Описание**: Альтернативное название для `EXCEPT` в некоторых базах данных, например, в Oracle.
   - **Применение**: Используется аналогично `EXCEPT`.
   - **Синтаксис**:
     ```sql
     SELECT column_list FROM table1
     MINUS
     SELECT column_list FROM table2;
     ```

## Важные особенности операций над множествами

1. **Совпадение типов данных**:
   - Столбцы в соответствующих позициях в обоих запросах должны иметь совместимые типы данных.

2. **Количество столбцов**:
   - Количество столбцов, возвращаемых каждым запросом, должно быть одинаковым.

3. **Порядок выполнения**:
   - Операторы множеств выполняются после выполнения всех операторов `SELECT`, `FROM`, `WHERE`, и `GROUP BY` в отдельных запросах.

## Когда применять операции над множествами

1. **`UNION`**:
   - Когда нужно объединить результаты нескольких запросов, но оставить только уникальные строки.
   - Пример: Объединение списков сотрудников из разных отделов, где необходимо избежать дублирования.

2. **`UNION ALL`**:
   - Когда нужно объединить результаты нескольких запросов, сохраняя все дубликаты.
   - Пример: Объединение транзакций из разных таблиц, где важно учитывать каждую запись.

3. **`INTERSECT`**:
   - Когда нужно найти пересечения между двумя наборами данных.
   - Пример: Найти сотрудников, которые одновременно работают в двух разных компаниях.

4. **`EXCEPT`**:
   - Когда нужно исключить строки одного набора данных, присутствующие в другом.
   - Пример: Найти продукты, которые доступны на складе, но не представлены в текущем каталоге.

## Заключение

Операции над множествами в SQL — это мощный инструмент для работы с данными, позволяющий комбинировать результаты запросов различными способами. Знание того, как и когда применять эти операции, значительно расширяет возможности по обработке данных и построению эффективных запросов.

---


### Дополнение: 

Когда используешь операции над множествами, такие как `UNION`, `INTERSECT` или `EXCEPT`, каждый из объединяемых запросов должен возвращать одинаковое количество столбцов. Это необходимо, потому что SQL рассматривает результаты каждого запроса как наборы данных (множества), и для корректного объединения или сравнения этих множеств нужно, чтобы их структура была одинаковой.

Например: 

```SQL 
SELECT name, age FROM employees
UNION
SELECT name, age FROM contractors;
```

Оба запроса возвращают по два столбца (`name` и `age`), что делает объединение возможным. Если бы один запрос возвращал два столбца, а другой — три, SQL не смог бы правильно сопоставить строки между собой.


---

Операция `EXCEPT ALL` в PostgreSQL — это расширенная версия операции `EXCEPT`, которая используется для возврата всех строк, присутствующих в первом запросе, но не присутствующих во втором, включая дубликаты. В отличие от стандартного `EXCEPT`, который удаляет дубликаты, `EXCEPT ALL` сохраняет их.

### Как работает `EXCEPT ALL`

- **Сравнение строк:** `EXCEPT ALL` сравнивает строки из двух запросов.
- **Учет дубликатов:** Если строка встречается несколько раз в первом запросе, и она не встречается во втором запросе, то все её экземпляры будут возвращены в результат.
- **Удаление строк:** Если строка встречается в обоих запросах, то `EXCEPT ALL` удаляет из результата только столько экземпляров этой строки, сколько присутствует во втором запросе.

### Пример

Предположим, у нас есть две таблицы: `table_a` и `table_b`.

```sql
CREATE TABLE table_a (value INT);
CREATE TABLE table_b (value INT);

INSERT INTO table_a (value) VALUES (1), (2), (2), (3), (3), (3);
INSERT INTO table_b (value) VALUES (2), (3), (3), (4);
```

В таблице `table_a` содержатся следующие данные:

| value |
|-------|
| 1     |
| 2     |
| 2     |
| 3     |
| 3     |
| 3     |

В таблице `table_b` содержатся следующие данные:

| value |
|-------|
| 2     |
| 3     |
| 3     |
| 4     |

Теперь рассмотрим запрос с использованием `EXCEPT ALL`:

```sql
SELECT value FROM table_a
EXCEPT ALL
SELECT value FROM table_b;
```

**Результат:**

| value |
|-------|
| 1     |
| 2     |
| 3     |

### Пояснение результата:

- **Значение `1`:** Присутствует только в `table_a`, поэтому оно будет в результате.
- **Значение `2`:** В `table_a` есть два экземпляра `2`, а в `table_b` только один. Поэтому один экземпляр `2` будет возвращён.
- **Значение `3`:** В `table_a` есть три экземпляра `3`, а в `table_b` два. Поэтому один экземпляр `3` будет возвращён.
- **Значение `4`:** Присутствует только в `table_b`, поэтому оно не попадает в результат.

### Использование `EXCEPT ALL`

`EXCEPT ALL` полезен, когда ты хочешь сравнить данные из двух множеств с учётом дубликатов. Это может быть полезно в случаях, когда необходимо отобразить все различия между двумя наборами данных, включая сколько раз та или иная строка встречается в первом множестве, но не во втором.


---
### Важно: 

Когда используешь операции над множествами (`UNION`, `INTERSECT`, `EXCEPT`), SQL воспринимает результат каждого запроса как одно или несколько множеств. В каждом из этих множеств столбцы сопоставляются между собой по позиции (например, первый столбец из первого запроса с первым столбцом из второго запроса). Поэтому даже если названия столбцов разные (как в твоем примере `country` и `ship_country`), SQL объединит их в одно множество, если типы данных совместимы.

**Важно:**
- Если ты используешь `UNION`, `INTERSECT` или `EXCEPT`, ты ==всегда получаешь ровно то количество столбцов, которое возвращает каждый отдельный запрос==. Если в каждом запросе по одному столбцу, то результат будет содержать один столбец.
- Это отличается от `JOIN`, где результат может включать все столбцы из обеих таблиц.

Пример:

```sql
SELECT country
FROM customers
UNION
SELECT ship_country
FROM orders;
```

В этом случае результат будет одним столбцом, содержащим все уникальные значения стран из двух запросов.

Так что да, работа с множествами — это о том, как объединить или сравнить наборы данных, а не о том, как связать строки из разных таблиц, как в случае с `JOIN`.
