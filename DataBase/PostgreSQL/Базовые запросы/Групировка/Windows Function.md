---
создал заметку: 2024-08-30
---
---
Оконные функции в PostgreSQL — это мощный инструмент, который позволяет выполнять расчёты в рамках набора строк (называемого "окном") без группировки данных, как это делает `GROUP BY`. Основное отличие заключается в том, что оконные функции позволяют сохранить исходные строки в результате, а `GROUP BY` фактически агрегирует строки, оставляя только одну строку на каждую группу.

### Основные особенности оконных функций:
1. **Операции над набором строк (окном)**: Оконные функции работают в рамках набора строк, который может быть определён с помощью предложения `OVER()`. Это "окно" может включать в себя текущую строку и другие строки, которые соответствуют определённому условию (например, все строки в пределах одной группы или строки, отсортированные определённым образом).

2. **Не изменяют количество строк в результате**: В отличие от `GROUP BY`, который объединяет строки и возвращает одну строку на каждую группу, оконные функции возвращают столько строк, сколько было в исходных данных, но добавляют к ним новые вычисленные значения.

3. **Используются совместно с предложением `OVER()`**: Это предложение определяет окно, над которым будет выполнена функция. Внутри `OVER()` можно указать:
   - Разделение строк (`PARTITION BY`): Как бы "группировка", но без агрегации строк.
   - Сортировка строк (`ORDER BY`): Определяет порядок строк внутри окна.
   - Границы окна (`ROWS BETWEEN`): Устанавливает диапазон строк относительно текущей строки.

### Пример: 
Рассмотрим простой пример с таблицей продаж, где нужно посчитать сумму продаж по каждому продавцу, а также общую сумму всех продаж.

```sql
CREATE TABLE sales (
    id SERIAL PRIMARY KEY,
    seller_id INT,
    sale_amount NUMERIC
);

INSERT INTO sales (seller_id, sale_amount) VALUES
(1, 100),
(1, 200),
(2, 150),
(2, 250),
(3, 300);
```

Предположим, нужно вывести данные по каждой продаже, а также добавить в результат две дополнительные колонки:
- **Сумма продаж по каждому продавцу**.
- **Общая сумма продаж по всем продавцам**.

```sql
SELECT
    seller_id,
    sale_amount,
    SUM(sale_amount) OVER (PARTITION BY seller_id) AS total_sales_by_seller,
    SUM(sale_amount) OVER () AS total_sales
FROM
    sales;
```

**Результат будет таким:**

| seller_id | sale_amount | total_sales_by_seller | total_sales |
|-----------|-------------|-----------------------|-------------|
| 1         | 100         | 300                   | 1000        |
| 1         | 200         | 300                   | 1000        |
| 2         | 150         | 400                   | 1000        |
| 2         | 250         | 400                   | 1000        |
| 3         | 300         | 300                   | 1000        |

**Объяснение:**
- `SUM(sale_amount) OVER (PARTITION BY seller_id)` рассчитывает сумму продаж для каждого продавца (`PARTITION BY seller_id` указывает, что окно будет разбито по каждому продавцу).
- `SUM(sale_amount) OVER ()` рассчитывает общую сумму продаж по всей таблице (так как `OVER ()` без параметров означает, что окно охватывает все строки таблицы).

### Как это связано с `GROUP BY`?
- Если бы вы использовали `GROUP BY`, результат был бы другим, потому что данные были бы агрегированы по продавцам, и вы бы потеряли данные о каждой отдельной продаже:
  
```sql
SELECT
    seller_id,
    SUM(sale_amount) AS total_sales_by_seller
FROM
    sales
GROUP BY
    seller_id;
```

**Результат был бы таким:**

| seller_id | total_sales_by_seller |
|-----------|-----------------------|
| 1         | 300                   |
| 2         | 400                   |
| 3         | 300                   |

Здесь мы видим, что строки агрегированы по `seller_id`, и мы теряем информацию о каждой отдельной продаже.

### Когда использовать оконные функции?
- Когда нужно выполнить расчёты, сохраняя исходные строки в результатах.
- Когда нужны более сложные вычисления, например, расчёт скользящих средних, ранжирование строк, или расчёт долей.
- Когда нужно выполнить агрегацию, не объединяя строки.

Оконные функции дают вам возможность оставаться гибким и не терять детали данных, которые часто важны при анализе и отчётности.

---