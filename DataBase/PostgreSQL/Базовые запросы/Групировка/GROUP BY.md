---
создал заметку: 2024-08-09
---


### `GROUB BY - располагается между =WHERE= и =ORDER BY=`   

### Как происходит группировка данных

Когда мы используем оператор `GROUP BY`, SQL выполняет следующие шаги:

1. **Создание групп**: SQL сканирует все строки таблицы и формирует группы строк, которые имеют одинаковые значения в столбцах, указанных в `GROUP BY`. Эти группы формируются на основе значений в указанных столбцах. Если в запросе есть несколько столбцов, то группа будет формироваться по уникальным комбинациям значений этих столбцов.
    
2. **Применение агрегатных функций**: После того как группы сформированы, SQL вычисляет агрегатные функции для каждой группы. Агрегатные функции такие как `COUNT()`, `SUM()`, `AVG()` и другие вычисляют результат на основе данных в каждой группе.
### Пример с группировкой

Рассмотрим таблицу `sales`:

| id  | product | amount |
| --- | ------- | ------ |
| 1   | A       | 10     |
| 2   | B       | 20     |
| 3   | A       | 30     |
| 4   | B       | 40     |

```SQL 
SELECT product, COUNT(*)
FROM sales
GROUP BY product;
```

#### Как происходит группировка и агрегирование:

1. **Создание групп**:
    
    - SQL сначала находит все строки и группирует их по значению в столбце `product`.
    - Группы будут такими:
        - Группа 1: строки, где `product` = 'A' (строки 1 и 3).
        - Группа 2: строки, где `product` = 'B' (строки 2 и 4).
2. **Применение агрегатной функции**:
    
    - Для каждой группы вычисляется агрегатная функция. В этом случае используется `COUNT(*)`, которая считает количество строк в каждой группе.
    - Для группы с `product` = 'A' результат будет `COUNT(*) = 2`, так как в этой группе две строки.
    - Для группы с `product` = 'B' результат будет `COUNT(*) = 2`, так как в этой группе тоже две строки.
3. **Формирование результата**:
    
    - Результат запроса будет содержать строки, которые представляют каждую уникальную группу и соответствующие агрегированные данные.
        
    В нашем случае результат будет:

| product | count |
| ------- | ----- |
| A       | 2     |
| B       | 2     |
# Как это работает под капотом

1. **Сканирование таблицы**: SQL сканирует все строки таблицы `sales`.
    
2. **Группировка данных**:
    
    - SQL сравнивает значения в столбце `product` и собирает строки с одинаковыми значениями в одну группу.
    - Если встречаются одинаковые значения, SQL объединяет их в одну группу.
3. **Применение агрегатных функций**:
    
    - SQL применяет `COUNT(*)` к каждой группе, вычисляя количество строк в каждой из них.
4. **Возвращение результата**:
    
    - SQL возвращает результат в виде таблицы, где каждая строка представляет уникальное значение из `product` и соответствующий результат агрегатной функции.

---

## `GROUP BY` в PostgreSQL

Оператор `GROUP BY` в PostgreSQL используется для группировки строк в таблице на основе значений одного или нескольких столбцов. После группировки можно применять агрегатные функции для вычисления статистики по каждой группе.

### Основной синтаксис

```sql
SELECT column1, column2, aggregate_function(column3)
FROM table_name
GROUP BY column1, column2;
```

- `column1`, `column2` - столбцы, по которым происходит группировка.
- `aggregate_function(column3)` - агрегатная функция, применяемая к данным в каждой группе.

### Примеры использования

#### Простой пример с подсчётом количества строк

Таблица `sales`:

| id | product | amount |
|----|---------|--------|
| 1  | A       | 10     |
| 2  | B       | 20     |
| 3  | A       | 30     |
| 4  | B       | 40     |

Запрос:

```sql
SELECT product, COUNT(*)
FROM sales
GROUP BY product;
```

Результат:

| product | count |
|---------|-------|
| A       | 2     |
| B       | 2     |

#### Применение агрегатных функций

Запрос для суммирования `amount` по каждому продукту:

```sql
SELECT product, SUM(amount)
FROM sales
GROUP BY product;
```

Результат:

| product | sum  |
|---------|------|
| A       | 40   |
| B       | 60   |

#### Фильтрация групп с `HAVING`

Чтобы найти продукты с суммой продаж более 40:

```sql
SELECT product, SUM(amount)
FROM sales
GROUP BY product
HAVING SUM(amount) > 40;
```

Результат:

| product | sum  |
|---------|------|
| B       | 60   |

#### Использование нескольких агрегатных функций

Запрос с несколькими агрегатными функциями:

```sql
SELECT product, COUNT(*) AS num_sales, SUM(amount) AS total_amount, AVG(amount) AS avg_amount
FROM sales
GROUP BY product;
```

Результат:

| product | num_sales | total_amount | avg_amount |
|---------|-----------|--------------|------------|
| A       | 2         | 40           | 20         |
| B       | 2         | 60           | 30         |

### Группировка по нескольким столбцам

Когда в запросе используется несколько столбцов в `GROUP BY`, группы формируются на основе уникальных комбинаций значений этих столбцов.

#### Пример с несколькими столбцами

Таблица `sales`:

| id | product | region | amount |
|----|---------|--------|--------|
| 1  | A       | East   | 10     |
| 2  | A       | West   | 20     |
| 3  | B       | East   | 30     |
| 4  | B       | East   | 40     |
| 5  | A       | East   | 50     |
| 6  | B       | West   | 60     |

Запрос:

```sql
SELECT product, region, COUNT(*) AS total_sales, SUM(amount) AS total_amount
FROM sales
GROUP BY product, region;
```

#### Как происходит группировка и агрегирование

1. **Создание групп**:
   - SQL сгруппирует строки по уникальным комбинациям значений в столбцах `product` и `region`.
   - Группы будут следующими:
     - Группа 1: (A, East)
     - Группа 2: (A, West)
     - Группа 3: (B, East)
     - Группа 4: (B, West)

2. **Применение агрегатных функций**:
   - Для группы `(A, East)`:
     - Количество строк: `COUNT(*) = 3`
     - Сумма `amount`: `SUM(amount) = 60`
   - Для группы `(A, West)`:
     - Количество строк: `COUNT(*) = 1`
     - Сумма `amount`: `SUM(amount) = 20`
   - Для группы `(B, East)`:
     - Количество строк: `COUNT(*) = 2`
     - Сумма `amount`: `SUM(amount) = 70`
   - Для группы `(B, West)`:
     - Количество строк: `COUNT(*) = 1`
     - Сумма `amount`: `SUM(amount) = 60`

3. **Формирование результата**:

Результат:

| product | region | total_sales | total_amount |
|---------|--------|-------------|--------------|
| A       | East   | 3           | 60           |
| A       | West   | 1           | 20           |
| B       | East   | 2           | 70           |
| B       | West   | 1           | 60           |

### Примечание о правилах использования `GROUP BY`

Оператор `GROUP BY` часто используется вместе с агрегатными функциями (MIN(), MAX(), SUM(), AVG(), COUNT() и др.). Агрегатные функции вычисляют значения для каждой группы строк, созданной с помощью `GROUP BY`.

### Сравнение с `JOIN`

- **`JOIN`**: Используется для объединения строк из двух или более таблиц на основе условия. Например, `INNER JOIN`, `LEFT JOIN` и другие типы `JOIN` позволяют комбинировать данные из разных таблиц.
- **`GROUP BY`**: Используется для группировки строк на основе значений столбцов и позволяет применять агрегатные функции к этим группам. 

Часто `GROUP BY` используется после `JOIN`, чтобы сгруппировать объединённые данные.

### Пример комбинации `JOIN` и `GROUP BY`

Таблицы `customers` и `orders`:

```sql
SELECT c.customer_id, c.customer_name, COUNT(o.order_id) AS total_orders, SUM(o.amount) AS total_amount
FROM customers c
INNER JOIN orders o ON c.customer_id = o.customer_id
GROUP BY c.customer_id, c.customer_name;
```

В этом запросе сначала происходит объединение таблиц с помощью `JOIN`, а затем результат группируется по `customer_id` и `customer_name`, применяя агрегатные функции к каждой группе.

---