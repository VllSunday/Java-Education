---
создал заметку: 2024-08-08
---

---

# Агрегатные функции в SQL

Агрегатные функции выполняют вычисления над набором значений и возвращают одно значение. В контексте табличной модели данных это означает, что функция берет ноль, одну или несколько строк для какого-то столбца и возвращает единственное значение.

Для сравнения, скалярные функции принимают на вход одно значение и возвращают одно значение. Пример скалярной функции: `abs` — функция, принимающая число и возвращающая абсолютное значение этого числа.


### ==Правило применения:== 
Агрегирующие функции в SQL, такие как `SUM`, `COUNT`, `AVG`, `MAX`, `MIN`, работают с группами данных. Когда вы используете агрегирующую функцию в запросе, вам нужно указать, как вы хотите сгруппировать данные, чтобы функция могла корректно выполнить свои вычисления.

### Доп информация: 
Использование агрегатных функций без `GROUP BY` возможно в случаях, когда агрегирование нужно по всей таблице или подмножеству данных. `GROUP BY` используется для вычисления агрегатов в пределах групп строк, что необходимо, если вы хотите получить значения, агрегированные по определенным критериям или столбцам.

По всей таблице:  
```SQL
SELECT SUM(units_in_stock) AS total_sum FROM products;
```

По подмножеству:Найти всех клиентов и количество заказов, которые они сделали, но только для тех клиентов, у которых больше одного заказа.
```SQL
SELECT * FROM ( SELECT AVG(price) AS average_price FROM products ) AS subquery;
```
## Свойства агрегатных функций

- **Игнорирование `NULL`-значений:** Агрегатные функции игнорируют `NULL`-значения. Исключение — функция `COUNT(*)`.
- **Детерминированность:** Агрегатные функции детерминированы. Это означает, что для одинакового набора данных функции возвращают одинаковое значение.

Агрегатные функции часто используются совместно с операторами `GROUP BY` и `HAVING`.

- **`GROUP BY`:** Группирует строки с одинаковыми значениями в одну строку.
- **`HAVING`:** Используется в качестве фильтра для запросов, в которых есть оператор `GROUP BY`.

### Использование ключевых слов `DISTINCT` и `ALL`

С агрегатными функциями можно использовать ключевые слова `DISTINCT` и `ALL`. Синтаксис выглядит следующим образом:

```SQL
aggregation_function(DISTINCT | ALL expression)
```

## Примеры агрегатных функций

### Функция `COUNT`

Функция `COUNT` считает количество строк в таблице. Она может принимать в качестве параметров как числовые, так и нечисловые типы данных.

- **`COUNT(*)`:** Специальная форма функции `COUNT`, которая возвращает количество всех строк в указанной таблице, включая дубликаты и `NULL`-значения.

Пример: Посчитаем количество сотрудников для каждой роли:

```SQL
SELECT role, COUNT(*) AS number_of_employee 
FROM employees 
GROUP BY role;
```

**Результат:**

| role    | number_of_employee |
| ------- | ------------------ |
| QA      | 1                  |
| Manager | 2                  |
| SWE     | 2                  |

Пример: Посчитаем количество уникальных офисов:

```SQL
SELECT COUNT(DISTINCT office_id) AS unique_offices 
FROM employees;
```

**Результат:** 2

### Функция `SUM`

Функция `SUM` вычисляет сумму всех выбранных значений столбца. Она работает только с числовыми полями.

Пример: Посчитать суммарную зарплату всех сотрудников:

```SQL
SELECT SUM(salary) AS total_salary 
FROM employees;
```

**Результат:** 2750

### Функции `MAX` и `MIN`

Эти функции находят максимальное (`MAX`) и минимальное (`MIN`) значение для определенного столбца.

Пример: Минимальная зарплата среди всех сотрудников:

```SQL
SELECT MIN(salary) AS min_salary 
FROM employees;
```

**Результат:** 500

Пример: Максимальная зарплата для каждого офиса, где больше двух сотрудников:

```SQL
SELECT office_id, MAX(salary) AS max_salary 
FROM employees 
GROUP BY office_id 
HAVING COUNT(*) > 2;
```

**Результат:**

| office_id | max_salary |
| --------- | ---------- |
| 2         | 750        |

### Функция `AVG`

Функция `AVG` используется для вычисления среднего значения заданного столбца.

Пример: Рассчитаем среднюю зарплату по всем сотрудникам:

```SQL
SELECT AVG(salary) AS avg_salary 
FROM employees;
```

**Результат:**

| avg_salary |
| ---------- |
| 687.50     |

**Важно:** Если в столбце `salary` есть значение `NULL`, функция `AVG` его проигнорирует.

### Где применяют агрегирующие функции

Агрегатные функции активно используются в различных проектах и продуктах. Например, с помощью этих функций:

- строят модели в аналитике;
- строят графики в реальном времени с метриками сервисов;
- пишут отчеты.

Для некоторых продуктов критически важна производительность агрегатных функций, особенно для построения аналитики в реальном времени. Существуют базы данных, оптимизированные для вычислений агрегатных функций, например, [ClickHouse](https://clickhouse.com/) и [Apache Druid](https://druid.apache.org/). Также есть хранилища данных, оптимизированные под выполнение запросов с агрегатными функциями, например, [Firebolt](https://www.firebolt.io/).

## Краткие итоги

Агрегатные функции — важная часть языка SQL, предоставляющая простой и понятный механизм для выполнения вычислений над набором данных. 

### Основные агрегатные функции:

- **`COUNT`:** Считает количество строк в таблице.
- **`SUM`:** Вычисляет сумму выбранных столбцов.
- **`MAX` и `MIN`:** Находят максимальное и минимальное значение определенного столбца.
- **`AVG`:** Вычисляет среднее значение столбца.

### Основные операторы для работы с агрегатными функциями:

- **`GROUP BY`:** Группирует строки с одинаковыми значениями в одну строку.
- **`HAVING`:** Используется как фильтр для запросов, в которых есть оператор `GROUP BY`.

--- 

Найти всех клиентов и количество заказов, которые они сделали, но только для тех клиентов, у которых больше одного заказа.